import time
from typing import TypedDict, List

from langgraph.graph import StateGraph, START, END
from typing import TypedDict, List, Annotated
from operator import add

class MyState(TypedDict):
    menu: Annotated[List[str], add]  # âœ… æ”¯æŒå¹¶è¡Œè¿½åŠ 
    all_ready: bool

# --- èŠ‚ç‚¹å®šä¹‰ ---
def start_cooking(state: MyState):
    print("ğŸ‘¨â€ğŸ³ å¨æˆ¿å‡†å¤‡å¼€å§‹ï¼")
    # åˆå§‹åŒ–å…±äº«èœå•åˆ—è¡¨
    state["menu"] = []
    return state


def chef_a(state: MyState):
    print("ğŸ‘©â€ğŸ³ A å¨å¸ˆåœ¨åšï¼šç•ªèŒ„ç‚’è›‹...")
    time.sleep(2)
    # å‘å…±äº« list æ·»åŠ èœå“
    # state["menu"].append("ç•ªèŒ„ç‚’è›‹") #è¿™ä¸ªå†™æ³•ä¼šå¯¼è‡´menué‡å¤
    # return state
    return {"menu": ["ç•ªèŒ„ç‚’è›‹"]} # å…³é”®æ˜¯ä¸è¦ã€ŒåŸåœ° appendã€ï¼Œè€Œæ˜¯åªè¿”å›è‡ªå·±é‚£ä»½ list



def chef_b(state: MyState):
    print("ğŸ‘¨â€ğŸ³ B å¨å¸ˆåœ¨åšï¼šå®«ä¿é¸¡ä¸...")
    time.sleep(3)
    # state["menu"].append("å®«ä¿é¸¡ä¸") #è¿™ä¸ªå†™æ³•ä¼šå¯¼è‡´menué‡å¤
    # return state
    return {"menu": ["å®«ä¿é¸¡ä¸"]} 


def chef_c(state: MyState):
    print("ğŸ‘©â€ğŸ³ C å¨å¸ˆåœ¨åšï¼šé±¼é¦™è‚‰ä¸...")
    time.sleep(1)
    # state["menu"].append("é±¼é¦™è‚‰ä¸") #è¿™ä¸ªå†™æ³•ä¼šå¯¼è‡´menué‡å¤
    # return state
    return {"menu": ["é±¼é¦™è‚‰ä¸"]}


def serve_dish(state: MyState):
    print("\nğŸ½ï¸ æ‰€æœ‰èœéƒ½å‡†å¤‡å¥½äº†ï¼èœå•å¦‚ä¸‹ï¼š")
    for dish in state["menu"]:
        print(" -", dish)
    # state["all_ready"] = True  #è¿™ä¸ªå†™æ³•ä¼šå¯¼è‡´menué‡å¤
    # return state
    return {"all_ready": True}


# --- æ„å»º LangGraph ---
def build_graph():
    graph_builder = StateGraph(MyState)
    graph_builder.add_node("start", start_cooking)
    graph_builder.add_node("chef_a", chef_a)
    graph_builder.add_node("chef_b", chef_b)
    graph_builder.add_node("chef_c", chef_c)
    graph_builder.add_node("serve", serve_dish)

    # å¯åŠ¨ â†’ å¹¶è¡Œä¸‰ä¸ªå¨å¸ˆ
    graph_builder.add_edge(START, "start")
    graph_builder.add_edge("start", "chef_a")
    graph_builder.add_edge("start", "chef_b")
    graph_builder.add_edge("start", "chef_c")

    # ä¸‰ä¸ªå¨å¸ˆæ±‡æ€»åˆ° serve
    graph_builder.add_edge(["chef_a", "chef_b", "chef_c"], "serve")
    # ç”±äºchef_aã€chef_bã€chef_cæ˜¯åŒæ­¥å‡½æ•°ï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯å¤šçº¿ç¨‹ã€‚
    # å¦‚æœchef_aã€chef_bã€chef_cæ˜¯å¼‚æ­¥å‡½æ•°ï¼Œé‚£ä¹ˆè¿™é‡Œå°±æ˜¯åç¨‹ã€‚

    graph_builder.add_edge("serve", END)

    return graph_builder.compile()


# --- è¿è¡Œ ---
if __name__ == "__main__":
    graph = build_graph()
    result = graph.invoke({})
    print("\næœ€ç»ˆç»“æœ:", result)

# åœ¨åŒä¸€ä¸ª stepï¼ˆä¹Ÿå°±æ˜¯ join é˜¶æ®µï¼‰ï¼Œå¤šä¸ªå¹¶å‘èŠ‚ç‚¹åŒæ—¶è¯•å›¾å†™å…¥åŒä¸€ä¸ªå±æ€§ï¼ˆæ¯”å¦‚ listï¼‰ï¼Œä¼šæŠ¥é”™ï¼Œå› ä¸ºæ¯ä¸ªstepä¹‹åªèƒ½æ”¹ä¸€æ¬¡ã€‚
# æ‰€ä»¥è¦åŠ ä¸ŠAnnotatedï¼Œæ‰èƒ½å¹¶è¡Œå†™å…¥ã€‚
# ä½†åŠ ä¸Š Annotated å,æœ¬æ¥æ˜¯åœ¨listé‡Œé¢ï¼Œä¸‰ä¸ªèŠ‚ç‚¹å„è¿½åŠ è¿½åŠ ä¸€ä¸ªå€¼ï¼Œåº”è¯¥æœ‰3ä¸ªå€¼ï¼Œä½†æ˜¯ç°åœ¨å˜æˆ24ä¸ªã€‚
# ç„¶åå‘ç°å› ä¸ºåœ¨ LangGraph ä¸­ï¼Œè™½ç„¶æ¯ä¸ªèŠ‚ç‚¹æ”¶åˆ°çš„ state æ˜¯ä¸€ä¸ªå¿«ç…§ï¼ˆæ‹·è´ï¼‰ï¼Œä½†è¿™ä¸ªå¿«ç…§é‡Œçš„ï¼Œå±æ€§ç”¨çš„æ˜¯åŒä¸€ä¸ªå¼•ç”¨ã€‚
# è€Œæˆ‘åœ¨æ¯ä¸ªèŠ‚ç‚¹é‡Œï¼Œä½¿ç”¨èŠ‚ç‚¹çš„è¾“å…¥stateè¿›è¡Œçš„append,ä¼šå¯¼è‡´ï¼Œåœ¨ä¸€ä¸ªå…±äº«çš„ list ä¸Šåšæ·»åŠ ï¼Œç„¶åå°†è¿™ä¸ªå®Œæ•´çš„stateè¿”å›
# è¿™æ ·å°±ä¼šå¯¼è‡´ï¼Œè¿”å›åˆå¹¶stateçš„æ—¶å€™ï¼Œä¼šå¯¼è‡´listçš„å¤§å°æŒ‡æ•°çº§å¢é•¿ã€‚åº”è¯¥æ˜¯åªéœ€è¦è¿”å›åŒ…å«è‡ªå·±è´¡çŒ®çš„æ–°listå°±è¡Œã€‚
# å†™æ³• 1ï¼šåŸåœ° appendï¼ˆä¼šå¯¼è‡´ 3 å˜ 24ï¼‰
# å†™æ³• 2ï¼šåªè¿”å›è‡ªå·±çš„è´¡çŒ®(æ°¸è¿œåªä¼šæœ‰ 3 ä¸ª)


# LangGraph æ¯ä¸ª key åœ¨ä¸€ä¸ª step é‡Œåªå…è®¸ä¸€ä¸ªæ›´æ–°ï¼ˆsingle-writer ruleï¼‰ã€‚
# å¦‚æœå¤šä¸ªå¹¶å‘èŠ‚ç‚¹å†™åŒä¸€ä¸ª keyï¼Œä¼šè§¦å‘ InvalidUpdateErrorã€‚
# å¿…é¡»ä½¿ç”¨ Annotated reducer æ‰èƒ½å…è®¸å¤šå€¼åˆå¹¶ã€‚**
# Annotated çš„ä½œç”¨æ˜¯å‘Šè¯‰ LangGraphï¼šè¿™ä¸ª key åœ¨å¹¶å‘åœºæ™¯ä¸‹éœ€è¦ç”¨ reducer åˆå¹¶å¤šä¸ªå€¼ã€‚
# ä¸åŠ  Annotated â†’ å¤šä¸ªåˆ†æ”¯å†™åŒä¸€ä¸ª key â†’ ç›´æ¥æŠ¥ InvalidUpdateErrorã€‚
# ä½†æ˜¯è¿˜æœ‰é—®é¢˜ï¼Œæœ¬æ¥æ˜¯åœ¨listé‡Œé¢ï¼Œä¸‰ä¸ªèŠ‚ç‚¹å„è¿½åŠ è¿½åŠ ä¸€ä¸ªå€¼ï¼Œåº”è¯¥æœ‰3ä¸ªå€¼ï¼Œä½†æ˜¯ç°åœ¨å˜æˆ12ä¸ªã€‚
# Annotated[List, add] + in-place append + å…±äº«å¼•ç”¨ â†’ çˆ†ç‚¸å¼ç´¯ç§¯
# æ‰€ä»¥è¿™é‡Œå»ºè®®è¡¥ä¸€å¥ï¼š
# å› ä¸º reducer add å¯¹ list æ˜¯æ‰©å±•ï¼ˆextendï¼‰ï¼Œ
# è€Œæ¯ä¸ªåˆ†æ”¯è¿”å›çš„æ˜¯ä¸€ä¸ªå·²ç»è¢«åˆ«çš„åˆ†æ”¯æ±¡æŸ“è¿‡çš„å®Œæ•´ listï¼Œ
# æ‰€ä»¥åˆå¹¶æ—¶ä¼šæŠŠæ•´ä¸ªåˆ—è¡¨åå¤ç›¸åŠ ï¼Œä»è€ŒæŒ‡æ•°å€å¢é•¿ã€‚
# LangGraph ä¸ºæ¯ä¸ªå¹¶è¡ŒèŠ‚ç‚¹åˆ›å»ºçš„æ˜¯â€œæµ…æ‹·è´çŠ¶æ€â€ã€‚
# æµ…æ‹·è´ä¼šå¯¼è‡´å¯å˜å¯¹è±¡ï¼ˆlist/dictï¼‰ä¾ç„¶å…±äº«åº•å±‚å¼•ç”¨ã€‚
# å› æ­¤å¤šä¸ªåˆ†æ”¯å¯¹ list çš„ append ä¼šäº’ç›¸å½±å“ã€‚
# è€Œæˆ‘åœ¨æ¯ä¸ªèŠ‚ç‚¹é‡Œï¼Œä½¿ç”¨èŠ‚ç‚¹çš„è¾“å…¥ state è¿›è¡Œ appendï¼Œä¼šå¯¼è‡´åœ¨ä¸€ä¸ªå…±äº«çš„ list ä¸Šåšæ·»åŠ ã€‚
# è¿™æ˜¯ä¸€ç§ in-place mutationï¼ˆåŸåœ°ä¿®æ”¹ï¼‰ï¼Œ
# åœ¨å¹¶å‘çŠ¶æ€ç®¡ç†æ¨¡å‹ä¸­æ˜¯å±é™©è¡Œä¸ºï¼Œå› ä¸ºä¼šç ´å reducer çš„åˆå¹¶è¯­ä¹‰ã€‚
# å› ä¸ºæ¯ä¸ªåˆ†æ”¯éƒ½è¿”å›â€œå®Œæ•´åˆ—è¡¨â€ï¼Œ
# reducer å¯¹å®Œæ•´åˆ—è¡¨æ‰§è¡ŒåŠ æ³•ï¼Œå˜æˆï¼š
# [å®Œæ•´åˆ—è¡¨] + [å®Œæ•´åˆ—è¡¨] + [å®Œæ•´åˆ—è¡¨]
# reducer å¤šæ¬¡æ‰§è¡Œ â†’ å€¼åå¤ç´¯ç§¯ â†’ 3â†’6â†’12â†’24â€¦
# åº”è¯¥æ˜¯åªéœ€è¦è¿”å›åŒ…å«è‡ªå·±è´¡çŒ®çš„æ–° list å°±è¡Œã€‚



# é¢è¯•æ ‡å‡†ç­”æ¡ˆï¼ˆä¸“ä¸šç‰ˆæ€»ç»“ï¼‰
# åœ¨ LangGraph ä¸­ï¼Œæ¯ä¸ª key åœ¨åŒä¸€ä¸ª step åªèƒ½æœ‰ä¸€ä¸ªå†™å…¥è€…ï¼ˆsingle-writer ruleï¼‰ã€‚
# å½“å¤šä¸ªå¹¶è¡ŒèŠ‚ç‚¹éœ€è¦å†™åŒä¸€ä¸ªå­—æ®µæ—¶ï¼Œå¿…é¡»ä½¿ç”¨ Annotated + reducer æ¥å‘Šè¯‰æ¡†æ¶å¦‚ä½•åˆå¹¶è¿™äº›å€¼ã€‚
# æˆ‘ä¸€å¼€å§‹ä½¿ç”¨çš„æ˜¯ï¼š
# menu: Annotated[List[str], add]
# ä½†æ˜¯å› ä¸ºæˆ‘åœ¨æ¯ä¸ªèŠ‚ç‚¹é‡Œå¯¹ state["menu"] åšäº† in-place appendï¼Œè€Œ LangGraph çš„ state æ˜¯æµ…æ‹·è´ï¼š
# æµ…æ‹·è´ä¼šå¯¼è‡´å¯å˜å¯¹è±¡ï¼ˆlistï¼‰åœ¨å¤šä¸ªåˆ†æ”¯ä¹‹é—´å…±äº«åº•å±‚å¼•ç”¨
# æ‰€ä»¥ 3 ä¸ªå¹¶å‘èŠ‚ç‚¹å¯¹åŒä¸€ä¸ª list åš appendï¼Œä¼šäº’ç›¸æ±¡æŸ“
# æ¯ä¸ªèŠ‚ç‚¹è¿”å›çš„ state éƒ½åŒ…å«â€œå®Œæ•´åˆ—è¡¨â€
# ç„¶å reducer add ä¼šå¯¹è¿™ä¸ªå®Œæ•´åˆ—è¡¨åšæ‰©å±•ï¼š
# [å®Œæ•´åˆ—è¡¨] + [å®Œæ•´åˆ—è¡¨] + [å®Œæ•´åˆ—è¡¨]
# éšç€ reducer å¤šæ¬¡è°ƒç”¨ï¼Œåˆ—è¡¨å†…å®¹æŒ‡æ•°å€å åŠ ï¼Œäºæ˜¯ 3 ä¸ªå…ƒç´ å˜æˆäº† 24 ä¸ªã€‚
# è§£å†³æ–¹å¼æ˜¯ï¼š
# å¹¶è¡ŒèŠ‚ç‚¹ä¸åº”è¯¥åŸåœ°ä¿®æ”¹å…±äº« listï¼Œè€Œåº”è¯¥è¿”å›ä¸åŒ…å«å‰¯ä½œç”¨çš„â€œè´¡çŒ®å€¼â€ï¼Œä¾‹å¦‚ï¼š
# return {"menu": ["ç•ªèŒ„ç‚’è›‹"]}
# reducer åªä¼šåˆå¹¶è´¡çŒ®å€¼ï¼Œå› æ­¤æœ€ç»ˆç»“æœæ˜¯ç¨³å®šä¸”æ­£ç¡®çš„ã€‚